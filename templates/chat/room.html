<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width,initial-scale=1">
        <title>Live Chat â€” Real-Time Empire</title>
        <style>
            /* Theme variables (day = light, night = dark). The `.theme-day` and `.theme-night`
               classes switch the CSS variables used throughout the UI. */
            :root{
                --bg:#0f1724;--panel:#0b1220;--accent:#7c5cff;--muted:#9aa4b2;--me:#1f8a70;
                --text:#e6eef6;--bubble-bg:rgba(255,255,255,0.03);--bubble-me:linear-gradient(90deg,var(--me),#22c2a1);
            }
            .theme-day{
                --bg:#f6f8fb; --panel:#ffffff; --accent:#4f46e5; --muted:#6b7280; --me:#0f766e;
                --text:#0b1220; --bubble-bg:#f3f4f6; --bubble-me:linear-gradient(90deg,var(--me),#06b6d4);
            }
            .theme-night{
                --bg:#071124; --panel:#0b1220; --accent:#7c5cff; --muted:#9aa4b2; --me:#1f8a70;
                --text:#e6eef6; --bubble-bg:rgba(255,255,255,0.03); --bubble-me:linear-gradient(90deg,var(--me),#22c2a1);
            }
            :root{background:var(--bg)}
            
            :root{ /* default uses night */ }
            html,body{height:100%;margin:0;font-family:Inter,Segoe UI,Roboto,'Helvetica Neue',Arial;background:linear-gradient(180deg,#071124 0,#081129 60%,#06101f 100%);color:#e6eef6}
            .app{display:flex;height:100vh;align-items:center;justify-content:center}
            .chat-wrap{width:1100px;height:80vh;background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));border-radius:14px;display:flex;overflow:hidden;box-shadow:0 20px 80px rgba(2,6,23,0.7)}
            .sidebar{width:280px;background:linear-gradient(180deg,rgba(255,255,255,0.01),rgba(255,255,255,0.005));padding:20px;display:flex;flex-direction:column;gap:18px}
            .brand{font-weight:700;font-size:1.2rem;color:var(--accent)}
            .user-box{display:flex;align-items:center;gap:12px}
            .avatar{width:48px;height:48px;border-radius:50%;background:linear-gradient(135deg,var(--accent),#ff7a9b);display:flex;align-items:center;justify-content:center;font-weight:700;color:#fff}
            .username{font-size:1rem}
            .btn-logout{margin-left:auto;background:transparent;border:1px solid rgba(255,255,255,0.06);padding:8px 12px;border-radius:10px;color:var(--muted);cursor:pointer}
            .users-list{flex:1;overflow:auto;padding-right:6px}
            .users-list h4{margin:0 0 8px 0;color:var(--muted);font-weight:600}
            .user-item{display:flex;align-items:center;gap:10px;padding:8px;border-radius:8px;margin-bottom:6px;background:transparent}
            .main{flex:1;display:flex;flex-direction:column}
            .header{display:flex;align-items:center;justify-content:space-between;padding:18px 24px;border-bottom:1px solid rgba(255,255,255,0.02)}
            .title{font-weight:700}
            .messages{flex:1;padding:18px;overflow:auto;display:flex;flex-direction:column;gap:10px}
            .msg-row{display:flex;gap:10px;align-items:flex-end}
            .bubble{max-width:70%;padding:10px 14px;border-radius:12px;background:var(--bubble-bg);color:var(--text)}
            .bubble.me{background:var(--bubble-me);color:#fff;border-bottom-right-radius:2px;margin-left:auto}
            .mention{background:rgba(255,255,255,0.06);color:#ffd27a;padding:2px 6px;border-radius:6px}
            .bubble.mentioned{box-shadow:0 6px 18px rgba(255,210,120,0.08);border:1px solid rgba(255,210,120,0.08)}
            .meta{font-size:0.8rem;color:var(--muted);margin-top:6px}
            .composer{display:flex;padding:14px;border-top:1px solid rgba(255,255,255,0.02);gap:10px}
            .input{flex:1;padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:#eaf0ff}
            .send{background:var(--accent);border:none;color:white;padding:12px 18px;border-radius:12px;cursor:pointer}
            /* Touch targets */
            button, .emoji, .user-item { touch-action: manipulation; }

            /* Mobile responsiveness */
            @media (max-width: 900px) {
                .chat-wrap{width:100%;height:100vh;border-radius:0;flex-direction:column}
                .sidebar{width:100%;height:140px;order:2;display:none;overflow:auto;padding:12px}
                .main{order:1;flex:1;display:flex;flex-direction:column}
                .header{padding:12px}
                .messages{padding:12px}
                .composer{position:fixed;left:0;right:0;bottom:0;padding:12px;background:var(--panel);box-shadow:0 -6px 30px rgba(2,6,23,0.4);z-index:60}
                .messages{padding-bottom:96px}
                .avatar{width:40px;height:40px}
                .brand{font-size:1rem}
                .user-item{padding:10px}
                #emojiPicker{left:0;right:0;bottom:56px;transform:none;max-width:100%;border-radius:12px}
                #emojiPicker .emoji{font-size:24px;padding:10px}
                #lightbox img{max-width:100%;max-height:100%}
            }
            .placeholder{color:var(--muted)}
        </style>
    </head>
    <body>
        <div class="app">
            <div class="chat-wrap">
                <aside class="sidebar">
                    <div class="brand">Real-Time Empire</div>
                    <div class="user-box">
                        <div class="avatar" id="avatar">U</div>
                        <div>
                            <div class="username" id="displayName">User</div>
                            <div class="placeholder">Online</div>
                        </div>
                        <button class="btn-logout" id="logoutBtn">Logout</button>
                    </div>
                    <div class="users-list">
                        <h4>Active</h4>
                        <div id="activeUsers">--</div>
                    </div>
                </aside>

                <section class="main">
                    <div class="header">
                                                <div style="display:flex;align-items:center;gap:12px">
                                                    <button id="usersToggle" title="Show users" style="background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--text);padding:8px 10px;border-radius:8px;cursor:pointer">â˜°</button>
                                                    <div class="title">Global Chat Room</div>
                                                    <div class="placeholder">Share your thoughts with everyone</div>
                                                </div>
                                                <div style="display:flex;align-items:center;gap:8px">
                                                        <button id="themeToggle" title="Toggle theme" style="background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--text);padding:8px 10px;border-radius:8px;cursor:pointer">ðŸŒ™</button>
                                                </div>
                    </div>
                    <div class="messages" id="messages"></div>
                    <div class="composer">
                        <button id="emojiBtn" title="Emoji" style="border-radius:8px;padding:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:var(--muted);cursor:pointer;margin-right:6px">ðŸ˜Š</button>
                                                <div id="emojiPicker" style="display:none;position:absolute;bottom:86px;left:50%;transform:translateX(-50%);background:rgba(0,0,0,0.75);padding:8px;border-radius:10px;display:flex;flex-direction:column;gap:8px;z-index:50;max-width:760px;box-shadow:0 12px 40px rgba(0,0,0,0.6)">
                                                    <div style="display:flex;gap:8px;align-items:center;padding:6px">
                                                        <input id="emojiSearch" placeholder="Search emoji (type name or char)" style="flex:1;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:#eaf0ff" />
                                                        <select id="emojiCategory" style="padding:8px;border-radius:8px;background:transparent;color:#eaf0ff;border:1px solid rgba(255,255,255,0.06)">
                                                            <option value="all">All</option>
                                                            <option value="smileys">Smileys</option>
                                                            <option value="people">People</option>
                                                            <option value="animals">Animals</option>
                                                            <option value="food">Food</option>
                                                            <option value="activities">Activities</option>
                                                            <option value="travel">Travel</option>
                                                            <option value="objects">Objects</option>
                                                            <option value="symbols">Symbols</option>
                                                            <option value="flags">Flags</option>
                                                        </select>
                                                    </div>
                                                    <div id="emojiGrid" style="display:flex;gap:6px;flex-wrap:wrap;max-height:260px;overflow:auto;padding:6px"></div>
                                                </div>

                        <textarea id="msgInput" class="input" rows="2" placeholder="Say something... (Enter to send)"></textarea>
                        <input id="imageInput" type="file" accept="image/*" style="display:none" />
                        <button id="uploadBtn" title="Attach image" style="border-radius:8px;padding:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:var(--muted);cursor:pointer;margin-right:6px">ðŸ“Ž</button>
                        <div style="display:flex;flex-direction:column;align-items:flex-end;gap:6px">
                            <div id="sendTarget" style="font-size:0.75rem;color:var(--muted);">Target: Global</div>
                            <button id="sendBtn" class="send">Send</button>
                        </div>
                    </div>
                </section>
            </div>
        </div>

        <!-- Private chat modal -->
        <div id="privateChat" style="display:none;position:fixed;right:12px;bottom:86px;width:360px;max-width:90%;height:60vh;background:var(--panel);border-radius:12px;box-shadow:0 20px 60px rgba(0,0,0,0.6);z-index:220;overflow:hidden;display:flex;flex-direction:column">
            <div style="padding:10px 12px;display:flex;align-items:center;gap:8px;border-bottom:1px solid rgba(255,255,255,0.03)">
                <strong id="privateTitle">Private</strong>
                <div style="flex:1"></div>
                <button id="privateClose" style="background:transparent;border:none;color:var(--muted);cursor:pointer">âœ•</button>
            </div>
            <div id="privateMessages" style="flex:1;overflow:auto;padding:12px;display:flex;flex-direction:column;gap:8px"></div>
            <div style="padding:10px;border-top:1px solid rgba(255,255,255,0.03);display:flex;gap:8px;align-items:center">
                <input id="privateInput" class="input" placeholder="Message privately..." style="flex:1" />
                <button id="privateSend" class="send">Send</button>
            </div>
        </div>

        <!-- Image lightbox/modal -->
        <div id="lightbox" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.85);align-items:center;justify-content:center;z-index:200">
            <button id="lbClose" style="position:absolute;top:20px;right:24px;background:transparent;border:none;color:#fff;font-size:28px;cursor:pointer">âœ•</button>
            <button id="lbPrev" style="position:absolute;left:20px;top:50%;transform:translateY(-50%);background:transparent;border:none;color:#fff;font-size:40px;cursor:pointer">â—€</button>
            <img id="lbImage" src="" alt="" style="max-width:90%;max-height:86%;border-radius:10px;box-shadow:0 20px 60px rgba(0,0,0,0.8)" />
            <button id="lbNext" style="position:absolute;right:20px;top:50%;transform:translateY(-50%);background:transparent;border:none;color:#fff;font-size:40px;cursor:pointer">â–¶</button>
        </div>

        <script>
            let username = null;
            let ws = null;
            const users = new Set();
            const imageMessages = [];// track image URLs in order for lightbox navigation

            function niceTime() { return new Date().toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'}); }

            function addMessage(text, from, isMe){
                const messages = document.getElementById('messages');
                const row = document.createElement('div');
                row.className = 'msg-row';
                const bubble = document.createElement('div');
                bubble.className = 'bubble' + (isMe? ' me':'');
                // highlight @mentions in the text
                const mentionsPattern = /@([A-Za-z0-9_]+)/g;
                const safeText = text ? text.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;') : '';
                const linked = safeText.replace(mentionsPattern, (m, name) => `<span class="mention">@${name}</span>`);
                bubble.innerHTML = `<strong>${from}</strong><div style="margin-top:6px">${linked}</div><div class='meta'>${niceTime()}</div>`;
                if (isMe) { row.style.justifyContent='flex-end'; }
                row.appendChild(bubble);
                messages.appendChild(row);
                messages.scrollTop = messages.scrollHeight;
            }

            // insert mention into composer when clicking active user
            function mentionUser(name){
                const ta = document.getElementById('msgInput');
                ta.value = (ta.value ? ta.value + ' ' : '') + `@${name} `;
                ta.focus();
            }

            function renderActive(){
                const el = document.getElementById('activeUsers');
                el.innerHTML = '';
                Array.from(users).sort().forEach(u => {
                        const item = document.createElement('div');
                        item.className = 'user-item';
                        item.style.cursor = 'pointer';
                        item.innerHTML = `<div style='width:36px;height:36px;border-radius:50%;background:linear-gradient(90deg,var(--accent),#ff7a9b);display:flex;align-items:center;justify-content:center;font-weight:700;margin-right:8px'>${u.charAt(0).toUpperCase()}</div><div>${u}</div>`;
                        item.addEventListener('click', ()=> openPrivateChat(u));
                        el.appendChild(item);
                });
            }

            function connect(){
                const protocol = location.protocol === 'https:' ? 'wss' : 'ws';
                ws = new WebSocket(protocol + '://' + location.host + '/ws/chat/');
                ws.onopen = ()=> console.log('ws open');
                ws.onmessage = e => {
                    const d = JSON.parse(e.data);
                    // register user for active list (global and private events include username)
                    if (d.username) users.add(d.username);
                    if (d.to) users.add(d.to);
                    renderActive();
                    // If there's an image_url, render the image (with optional caption)
                    if (d.image_url && !d.private) {
                        const caption = d.message || '';
                        // highlight mentions in caption
                        const safeCap = caption ? caption.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;') : '';
                        const linkedCap = safeCap.replace(/@([A-Za-z0-9_]+)/g, (m, name) => `<span class="mention">@${name}</span>`);
                        const messages = document.getElementById('messages');
                        const row = document.createElement('div');
                        row.className = 'msg-row';
                        const bubble = document.createElement('div');
                        bubble.className = 'bubble' + (d.username === username? ' me':'');
                        const img = document.createElement('img');
                        img.src = d.image_url;
                        img.style.maxWidth = '320px';
                        img.style.borderRadius = '10px';
                        img.style.display = 'block';
                        img.style.marginTop = '6px';
                            bubble.innerHTML = `<strong>${d.username}</strong>` + (caption? `<div style="margin-top:6px">${linkedCap}</div>` : '');
                            bubble.appendChild(img);
                            bubble.innerHTML += `<div class='meta'>${niceTime()}</div>`;
                            // register click to open lightbox
                            img.style.cursor = 'zoom-in';
                            img.addEventListener('click', ()=> openLightbox(d.image_url));
                            // track images for navigation
                            imageMessages.push(d.image_url);
                            if (d.username === username) { row.style.justifyContent='flex-end'; }
                        row.appendChild(bubble);
                        messages.appendChild(row);
                        messages.scrollTop = messages.scrollHeight;
                    } else if (d.private) {
                        // private message handling: deliver into the private modal if open, otherwise show a brief notification
                        const pFrom = d.username;
                        const pTo = d.to;
                        const other = (pFrom === username) ? pTo : pFrom;
                        // append to privateMessages if the modal is open for this other user
                        const pmModal = document.getElementById('privateChat');
                        const pmTarget = window.currentPrivateTarget || null;
                        const pmList = document.getElementById('privateMessages');
                        const row = document.createElement('div');
                        row.className = 'msg-row';
                        const bubble = document.createElement('div');
                        bubble.className = 'bubble' + (d.username === username? ' me':'');
                        const safe = d.message ? d.message.replace(/&/g, '&amp;').replace(/</g, '&lt;') : '';
                        bubble.innerHTML = `<strong>${d.username}</strong><div style="margin-top:6px">${safe}</div><div class='meta'>${new Date(d.timestamp||Date.now()).toLocaleTimeString()}</div>`;
                        row.appendChild(bubble);
                        // if modal open and same chat, append; otherwise simple alert badge (minimal)
                        if (pmModal.style.display === 'flex' && pmTarget === other) {
                            pmList.appendChild(row);
                            pmList.scrollTop = pmList.scrollHeight;
                        } else {
                            // small in-page notice: change document title briefly
                            document.title = `New message from ${other}`;
                            setTimeout(()=>{ document.title = 'Live Chat â€” Real-Time Empire'; }, 3000);
                        }
                    } else {
                        addMessage(d.message, d.username, d.username === username);
                        // if this message contains mentions and mentions include me, mark it
                        if (d.mentions && Array.isArray(d.mentions) && d.mentions.includes(username)){
                            // find last message bubble and mark
                            const msgs = document.getElementById('messages');
                            const last = msgs.lastElementChild;
                            if (last){
                                const bub = last.querySelector('.bubble');
                                if (bub) bub.classList.add('mentioned');
                            }
                        }
                    }
                };
                ws.onclose = ()=> console.log('ws closed');
            }

            async function logout(){
                await fetch('/chat/api/logout/', {method:'POST', credentials:'include'}).catch(()=>{});
                window.location.href = '/';
            }

            document.getElementById('logoutBtn').addEventListener('click', logout);

            // Main composer always sends to the global room. Use the private modal
            // input (below) to send 1-vs-1 messages so behavior is explicit.
            document.getElementById('sendBtn').addEventListener('click', ()=>{
                const v = document.getElementById('msgInput').value.trim();
                if (!v || !ws || ws.readyState !== WebSocket.OPEN) return;
                ws.send(JSON.stringify({message: v}));
                document.getElementById('msgInput').value = '';
            });

            // Private chat helpers
            window.currentPrivateTarget = null;

            async function openPrivateChat(target){
                if (!target || target === username) return;
                window.currentPrivateTarget = target;
                document.getElementById('privateTitle').textContent = `Chat â€” ${target}`;
                // indicate main composer target remains Global
                const tgt = document.getElementById('sendTarget');
                if (tgt) tgt.textContent = 'Target: Global';
                const modal = document.getElementById('privateChat');
                const list = document.getElementById('privateMessages');
                list.innerHTML = '';
                modal.style.display = 'flex';
                // fetch last messages
                try{
                    const resp = await fetch(`/chat/api/private_messages/?username=${encodeURIComponent(target)}`, {credentials:'include'});
                    if (resp.ok){
                        const data = await resp.json();
                        (data.messages||[]).forEach(m=>{
                            const row = document.createElement('div'); row.className='msg-row';
                            const bubble = document.createElement('div'); bubble.className='bubble'+(m.sender===username?' me':'');
                            bubble.innerHTML = `<strong>${m.sender}</strong><div style="margin-top:6px">${m.content||''}</div><div class='meta'>${new Date(m.timestamp).toLocaleTimeString()}</div>`;
                            row.appendChild(bubble); list.appendChild(row);
                        });
                        list.scrollTop = list.scrollHeight;
                    }
                }catch(e){console.warn('private history failed',e)}
                // inform server we want to join the private group (so further messages are delivered)
                if (ws && ws.readyState === WebSocket.OPEN){
                    ws.send(JSON.stringify({action:'join_private', to: target}));
                }
            }

            function closePrivateChat(){
                const target = window.currentPrivateTarget;
                if (!target) return;
                if (ws && ws.readyState === WebSocket.OPEN){
                    ws.send(JSON.stringify({action:'leave_private', to: target}));
                }
                window.currentPrivateTarget = null;
                document.getElementById('privateChat').style.display = 'none';
                const tgt = document.getElementById('sendTarget');
                if (tgt) tgt.textContent = 'Target: Global';
            }

            document.getElementById('privateClose').addEventListener('click', closePrivateChat);
            document.getElementById('privateSend').addEventListener('click', ()=>{
                const v = document.getElementById('privateInput').value.trim();
                if (!v || !ws || ws.readyState !== WebSocket.OPEN || !window.currentPrivateTarget) return;
                ws.send(JSON.stringify({action:'private_message', to: window.currentPrivateTarget, message: v}));
                document.getElementById('privateInput').value = '';
            });
            document.getElementById('privateInput').addEventListener('keydown', (e)=>{ if (e.key === 'Enter' && !e.shiftKey){ e.preventDefault(); document.getElementById('privateSend').click(); } });

            // Emoji picker handling
            const emojiBtn = document.getElementById('emojiBtn');
            const emojiPicker = document.getElementById('emojiPicker');
            emojiBtn.addEventListener('click', (e)=>{
                emojiPicker.style.display = emojiPicker.style.display === 'none' ? 'flex' : 'none';
            });
            document.querySelectorAll('#emojiPicker .emoji').forEach(el=>{
                el.addEventListener('click', ()=>{
                    const ta = document.getElementById('msgInput');
                    ta.value = ta.value + el.textContent;
                    ta.focus();
                    emojiPicker.style.display = 'none';
                });
            });

            // Image upload handling
            const uploadBtn = document.getElementById('uploadBtn');
            const imageInput = document.getElementById('imageInput');
            uploadBtn.addEventListener('click', ()=> imageInput.click());
            imageInput.addEventListener('change', async (e)=>{
                const file = e.target.files && e.target.files[0];
                if (!file) return;
                // upload via API
                const fd = new FormData(); fd.append('image', file);
                const resp = await fetch('/chat/api/upload_image/', { method: 'POST', body: fd, credentials: 'include' });
                if (!resp.ok) { alert('Upload failed'); return; }
                const data = await resp.json();
                const caption = document.getElementById('msgInput').value.trim();
                // send image message via websocket (image_url + optional caption)
                if (ws && ws.readyState === WebSocket.OPEN) {
                    ws.send(JSON.stringify({ image_url: data.image_url, message: caption }));
                    document.getElementById('msgInput').value = '';
                } else {
                    alert('WebSocket not connected');
                }
            });

            // --- Emoji picker population (comprehensive set) ---
            // For practicality we include a large curated emoji list grouped by category.
            const EMOJI_LIBRARY = {
                smileys: 'ðŸ˜€ ðŸ˜ƒ ðŸ˜„ ðŸ˜ ðŸ˜† ðŸ˜… ðŸ˜‚ ðŸ¤£ ðŸ˜Š ðŸ˜‡ ðŸ™‚ ðŸ™ƒ ðŸ˜‰ ðŸ˜Œ ðŸ˜ ðŸ¥° ðŸ˜˜ ðŸ˜— ðŸ˜™ ðŸ˜š ðŸ˜‹ ðŸ˜› ðŸ˜ ðŸ˜œ ðŸ¤ª ðŸ¤¨ ðŸ§ ðŸ¤“ ðŸ˜Ž ðŸ¤©',
                people: 'ðŸ‘‹ ðŸ¤š ðŸ– âœ‹ ðŸ¤Ÿ ðŸ¤˜ ðŸ¤™ ðŸ‘ˆ ðŸ‘‰ ðŸ‘† ðŸ‘‡ âœŠ ðŸ‘Š ðŸ¤› ðŸ¤œ ðŸ¤ ðŸ‘ ðŸ‘Ž âœŒï¸ ðŸ‘ ðŸ™Œ ðŸ‘',
                animals: 'ðŸ¶ ðŸ± ðŸ­ ðŸ¹ ðŸ° ðŸ» ðŸ¼ ðŸ¨ ðŸ¯ ðŸ¦ ðŸ® ðŸ· ðŸ¸ ðŸµ ðŸ” ðŸ¦† ðŸ¦‰ ðŸ´ ðŸ ðŸ› ðŸ¦‹',
                food: 'ðŸ ðŸŽ ðŸ ðŸŠ ðŸ‹ ðŸŒ ðŸ‰ ðŸ‡ ðŸ“ ðŸ’ ðŸ‘ ðŸ¥­ ðŸ ðŸ¥¥ ðŸ¥ ðŸ… ðŸ¥‘ ðŸ† ðŸ¥” ðŸ¥• ðŸŒ½',
                activities: 'âš½ï¸ ðŸ€ ðŸˆ âš¾ï¸ ðŸŽ¾ ðŸ ðŸ‰ ðŸŽ± ðŸ“ ðŸ¸ ðŸ¥… â›³ï¸ ðŸ’ ðŸ¥Š ðŸ¥‹ â›¸ ðŸŽ£ ðŸ›· ðŸª',
                travel: 'ðŸš— ðŸš• ðŸš™ ðŸšŒ ðŸšŽ ðŸŽ ðŸš“ ðŸš‘ ðŸš’ ðŸš ðŸš² ðŸ›´ ðŸš‚ ðŸš† âœˆï¸ ðŸš€ â›µï¸ ðŸ›¶ ðŸ ðŸ–',
                objects: 'âŒšï¸ ðŸ“± ðŸ’» ðŸ–¥ ðŸ–¨ ðŸŽ§ ðŸ“· ðŸ“¸ ðŸ”‹ ðŸ”Œ ðŸ’¡ ðŸ”¦ ðŸ§­ ðŸ”‘ ðŸ§° ðŸ§² ðŸ§ª ðŸ§¯ ðŸ› ',
                symbols: 'â¤ï¸ ðŸ’” ðŸ’– ðŸ’˜ ðŸ’ ðŸ’ž ðŸ’™ ðŸ’š ðŸ’› ðŸ’œ ðŸ–¤ ðŸ’¯ ðŸ”¥ â­ï¸ ðŸŒŸ âœ¨ âš¡ï¸ â˜€ï¸ â˜ï¸ â„ï¸',
                flags: 'ðŸ³ï¸ ðŸ´ ðŸ ðŸš© ðŸ‡ºðŸ‡¸ ðŸ‡¬ðŸ‡§ ðŸ‡¨ðŸ‡¦ ðŸ‡¦ðŸ‡º ðŸ‡®ðŸ‡³ ðŸ‡©ðŸ‡ª ðŸ‡«ðŸ‡· ðŸ‡ªðŸ‡¸ ðŸ‡®ðŸ‡¹'
            };

            const emojiGrid = document.getElementById('emojiGrid');
            const emojiSearch = document.getElementById('emojiSearch');
            const emojiCategory = document.getElementById('emojiCategory');

            function populateEmojis(filter='all', query=''){
                emojiGrid.innerHTML = '';
                const cats = filter === 'all' ? Object.keys(EMOJI_LIBRARY) : [filter];
                const q = query.trim().toLowerCase();
                cats.forEach(cat => {
                    const list = EMOJI_LIBRARY[cat].split(' ').filter(Boolean);
                    list.forEach(ch => {
                        if (q && !ch.includes(q)) {
                            // simple char search; we don't have names for all emojis here
                        }
                        const span = document.createElement('button');
                        span.type = 'button';
                        span.className = 'emoji';
                        span.style.padding = '6px';
                        span.style.border = 'none';
                        span.style.background = 'transparent';
                        span.style.fontSize = '20px';
                        span.style.cursor = 'pointer';
                        span.textContent = ch;
                        span.addEventListener('click', ()=>{
                            const ta = document.getElementById('msgInput');
                            ta.value = ta.value + ch;
                            ta.focus();
                            emojiPicker.style.display = 'none';
                        });
                        emojiGrid.appendChild(span);
                    });
                });
            }

            populateEmojis();
            emojiSearch.addEventListener('input', (e)=> populateEmojis(emojiCategory.value, e.target.value));
            emojiCategory.addEventListener('change', ()=> populateEmojis(emojiCategory.value, emojiSearch.value));

            // Lightbox behaviors
            const lightbox = document.getElementById('lightbox');
            const lbImage = document.getElementById('lbImage');
            const lbClose = document.getElementById('lbClose');
            const lbPrev = document.getElementById('lbPrev');
            const lbNext = document.getElementById('lbNext');
            let lbIndex = -1;

            function openLightbox(url){
                lbIndex = imageMessages.indexOf(url);
                if (lbIndex === -1) { imageMessages.push(url); lbIndex = imageMessages.length - 1; }
                lbImage.src = imageMessages[lbIndex];
                lightbox.style.display = 'flex';
            }
            function closeLightbox(){ lightbox.style.display = 'none'; }
            function lbNavigate(delta){
                if (imageMessages.length === 0) return;
                lbIndex = (lbIndex + delta + imageMessages.length) % imageMessages.length;
                lbImage.src = imageMessages[lbIndex];
            }
            lbClose.addEventListener('click', closeLightbox);
            lbPrev.addEventListener('click', ()=> lbNavigate(-1));
            lbNext.addEventListener('click', ()=> lbNavigate(1));
            lightbox.addEventListener('click', (e)=>{ if (e.target === lightbox) closeLightbox(); });

            document.getElementById('msgInput').addEventListener('keydown', (e)=>{
                if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); document.getElementById('sendBtn').click(); }
            });

            // Mobile: toggle users sidebar
            const usersToggle = document.getElementById('usersToggle');
            usersToggle && usersToggle.addEventListener('click', ()=>{
                const sb = document.querySelector('.sidebar');
                if (!sb) return;
                if (getComputedStyle(sb).display === 'none') {
                    sb.style.display = 'block';
                } else {
                    sb.style.display = 'none';
                }
            });

            // Mobile emoji behavior: open full picker if narrow
            emojiBtn.addEventListener('click', (e)=>{
                const isMobile = window.matchMedia('(max-width:900px)').matches;
                if (isMobile) {
                    // show as block (full width) and scroll into view
                    emojiPicker.style.display = 'flex';
                    emojiPicker.scrollIntoView({behavior:'smooth',block:'center'});
                } else {
                    emojiPicker.style.display = emojiPicker.style.display === 'none' ? 'flex' : 'none';
                }
            });

            // ensure composer is visible when input focused on mobile (avoid being covered by keyboard)
            const msgInput = document.getElementById('msgInput');
            msgInput.addEventListener('focus', ()=>{ if (window.matchMedia('(max-width:900px)').matches) window.scrollTo({top:document.body.scrollHeight,behavior:'smooth'}); });

            // fetch current user and initialize
            // --- Theme initialization: apply saved theme or default to night ---
            (function(){
                const saved = localStorage.getItem('rte_theme');
                const root = document.documentElement;
                if (saved === 'day') {
                    root.classList.remove('theme-night'); root.classList.add('theme-day');
                    document.getElementById('themeToggle').textContent = 'â˜€ï¸';
                } else {
                    root.classList.remove('theme-day'); root.classList.add('theme-night');
                    document.getElementById('themeToggle').textContent = 'ðŸŒ™';
                }
                document.getElementById('themeToggle').addEventListener('click', ()=>{
                    const isDay = document.documentElement.classList.contains('theme-day');
                    if (isDay){
                        document.documentElement.classList.remove('theme-day'); document.documentElement.classList.add('theme-night');
                        localStorage.setItem('rte_theme','night'); document.getElementById('themeToggle').textContent = 'ðŸŒ™';
                    } else {
                        document.documentElement.classList.remove('theme-night'); document.documentElement.classList.add('theme-day');
                        localStorage.setItem('rte_theme','day'); document.getElementById('themeToggle').textContent = 'â˜€ï¸';
                    }
                });
            })();

            fetch('/chat/api/me/', {credentials:'include'}).then(r=>{
                if (r.status !== 200) throw new Error('not auth');
                return r.json();
            }).then(data=>{
                username = data.username;
                document.getElementById('displayName').textContent = username;
                document.getElementById('avatar').textContent = username.charAt(0).toUpperCase();
                users.add(username); renderActive(); connect();
            }).catch(()=>{ window.location.href = '/'; });
        </script>
    </body>
</html>